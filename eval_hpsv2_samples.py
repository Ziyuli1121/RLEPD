#!/usr/bin/env python3
"""
Quick HPSv2.1 pass on a set of MS-COCO samples generated by sample.py.
"""

import argparse
import csv
from dataclasses import dataclass
from typing import Iterable, List, Optional

from pathlib import Path

from hpsv2.img_score import score as hps_score
from torch_utils.download_util import check_file_by_key


def parse_seed_spec(spec: str) -> List[int]:
    seeds: List[int] = []
    for chunk in spec.split(","):
        chunk = chunk.strip()
        if not chunk:
            continue
        if "-" in chunk:
            lo, hi = chunk.split("-", 1)
            seeds.extend(range(int(lo), int(hi) + 1))
        else:
            seeds.append(int(chunk))
    return sorted(set(seeds))


def load_prompts(prompt_csv: Optional[Path]) -> List[str]:
    if prompt_csv is None:
        prompt_path, _ = check_file_by_key("prompts")
        prompt_csv = Path(prompt_path)
    with prompt_csv.open("r", encoding="utf-8") as handle:
        reader = csv.DictReader(handle)
        return [row["text"] for row in reader]


@dataclass
class Sample:
    seed: int
    image_path: Path
    prompt: str


def build_samples(image_root: Path, seeds: Iterable[int], prompts: List[str]) -> List[Sample]:
    samples: List[Sample] = []
    for seed in seeds:
        subdir = f"{seed - seed % 1000:06d}"
        image_path = image_root / subdir / f"{seed:06d}.png"
        if not image_path.exists():
            raise FileNotFoundError(f"Missing image for seed {seed}: {image_path}")
        try:
            prompt = prompts[seed]
        except IndexError as exc:
            raise ValueError(f"Prompt list shorter than requested seed {seed}") from exc
        samples.append(Sample(seed=seed, image_path=image_path, prompt=prompt))
    return samples


def main() -> None:
    parser = argparse.ArgumentParser(description="Evaluate HPSv2 scores on generated samples.")
    parser.add_argument(
        "--image-root",
        type=Path,
        required=True,
        help="Directory that contains sample.py outputs (e.g. samples/ms_coco/epd_parallel_nfe36_npoints_2).",
    )
    parser.add_argument(
        "--weights",
        type=Path,
        default=Path(__file__).resolve().parent / "weights" / "HPS_v2.1_compressed.pt",
        help="Path to HPSv2.1 checkpoint.",
    )
    parser.add_argument(
        "--seeds",
        type=str,
        default="0-29",
        help="Comma-separated seeds or ranges (default: 0-29).",
    )
    parser.add_argument(
        "--prompts-csv",
        type=Path,
        default=None,
        help="Optional CSV with MS-COCO prompts; defaults to the file used by sample.py.",
    )
    parser.add_argument(
        "--hps-version",
        choices=("v2.0", "v2.1"),
        default="v2.1",
        help="HPS model release (default: v2.1).",
    )
    parser.add_argument(
        "--output",
        type=Path,
        default=None,
        help="Optional CSV file to store per-image scores.",
    )
    args = parser.parse_args()

    seeds = parse_seed_spec(args.seeds)
    if not seeds:
        raise ValueError("No seeds parsed from --seeds.")

    prompts = load_prompts(args.prompts_csv)
    samples = build_samples(args.image_root, seeds, prompts)

    results = []
    for sample in samples:
        value = hps_score(str(sample.image_path), sample.prompt, cp=str(args.weights), hps_version=args.hps_version)[0]
        results.append((sample, value))
        print(f"seed {sample.seed:6d} | score {value:7.4f} | prompt: {sample.prompt}")

    avg = sum(value for _, value in results) / len(results)
    print(f"\nAverage HPS {args.hps_version}: {avg:.4f}")

    if args.output is not None:
        args.output.parent.mkdir(parents=True, exist_ok=True)
        with args.output.open("w", newline="", encoding="utf-8") as handle:
            writer = csv.writer(handle)
            writer.writerow(["seed", "image_path", "score", "prompt"])
            for sample, value in results:
                writer.writerow([sample.seed, str(sample.image_path), f"{value:.6f}", sample.prompt])
            writer.writerow(["average", "", f"{avg:.6f}", ""])


if __name__ == "__main__":
    main()


'''

python eval_hpsv2_samples.py \
  --image-root samples/ms_coco/epd_parallel_nfe36_npoints_2 \
  --weights weights/HPS_v2.1_compressed.pt \
  --seeds 0-29 \
  --output hps_eval.csv

'''